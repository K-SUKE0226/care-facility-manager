<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”— æ–½è¨­URLæŠ½å‡ºãƒ„ãƒ¼ãƒ« - ä»‹è­·æ–½è¨­ä¸€è¦§ã‚µã‚¤ãƒˆå¯¾å¿œ</title>
    <style>
        body {
            font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c5282;
            text-align: center;
            border-bottom: 3px solid #3182ce;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        .input-section {
            background-color: #f8fafc;
            border: 2px solid #3182ce;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }
        #urlInput {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-family: monospace;
            line-height: 1.5;
            resize: vertical;
            box-sizing: border-box;
        }
        .btn {
            background: linear-gradient(135deg, #3182ce, #2c5282);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 15px;
            box-shadow: 0 4px 12px rgba(49, 130, 206, 0.3);
        }
        .btn:hover {
            background: linear-gradient(135deg, #2c5282, #2a4a7a);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .clear-btn {
            background-color: #ed8936;
            box-shadow: 0 4px 12px rgba(237, 137, 54, 0.3);
        }
        .download-btn {
            background-color: #38a169;
            box-shadow: 0 4px 12px rgba(56, 161, 105, 0.3);
        }
        .progress-section {
            display: none;
            background-color: #fffaf0;
            border: 2px solid #ed8936;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #38a169, #48bb78);
            transition: width 0.3s ease;
            width: 0%;
        }
        .progress-text {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
            text-align: center;
            margin-bottom: 15px;
        }
        .log {
            max-height: 200px;
            overflow-y: auto;
            background-color: #1a202c;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
            line-height: 1.5;
        }
        .results-section {
            display: none;
            background-color: #f0fff4;
            border: 2px solid #38a169;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-item {
            text-align: center;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            flex: 1;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #3182ce;
            display: block;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        .info-note {
            background-color: #e6fffa;
            border-left: 4px solid #319795;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .url-list {
            max-height: 300px;
            overflow-y: auto;
            background-color: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .url-item {
            padding: 8px 0;
            border-bottom: 1px solid #f7fafc;
            font-family: monospace;
            font-size: 13px;
            word-break: break-all;
        }
        .url-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”— æ–½è¨­URLæŠ½å‡ºãƒ„ãƒ¼ãƒ«</h1>
        
        <div class="info-note">
            <strong>ã“ã®ãƒ„ãƒ¼ãƒ«ã«ã¤ã„ã¦:</strong><br>
            ä»‹è­·æ–½è¨­é‹å–¶ä¼šç¤¾ã®æ–½è¨­ä¸€è¦§ãƒšãƒ¼ã‚¸ã‹ã‚‰ã€å€‹åˆ¥æ–½è¨­ã®URLã‚’è‡ªå‹•æŠ½å‡ºã—ã¾ã™ã€‚<br>
            æŠ½å‡ºã—ãŸURLã¯ã€æ–½è¨­ç®¡ç†ã‚·ãƒ¼ãƒˆã§ã®ä¸€æ‹¬ãƒ‡ãƒ¼ã‚¿å–å¾—ã«ä½¿ç”¨ã§ãã¾ã™ã€‚
        </div>
        
        <div class="input-section">
            <h3>ğŸŒ æ–½è¨­ä¸€è¦§ãƒšãƒ¼ã‚¸ã®URL</h3>
            <p>æ–½è¨­ä¸€è¦§ãŒæ²è¼‰ã•ã‚Œã¦ã„ã‚‹ãƒšãƒ¼ã‚¸ã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:</p>
            <textarea id="urlInput" placeholder="ä¾‹:
https://noah-garden.com/noah/search
https://www.minnannokaigo.com/search/hokkaido/sapporo/
https://kaigo.homes.co.jp/s/list/ad11=1/ct=5/area2=102/
..."></textarea>
            <div style="margin-top: 15px;">
                <button onclick="startExtraction()" class="btn" id="extractBtn">
                    ğŸ” URLæŠ½å‡ºé–‹å§‹
                </button>
                <button onclick="clearInput()" class="clear-btn btn">
                    ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
                </button>
            </div>
        </div>
        
        <div id="progressSection" class="progress-section">
            <h3>âš¡ æŠ½å‡ºçŠ¶æ³</h3>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <div id="progressText" class="progress-text">æº–å‚™ä¸­...</div>
            <div id="logContainer" class="log"></div>
        </div>
        
        <div id="resultsSection" class="results-section">
            <h3>ğŸ“‹ æŠ½å‡ºçµæœ</h3>
            <div class="stats">
                <div class="stat-item">
                    <span id="totalUrls" class="stat-number">0</span>
                    <span class="stat-label">æŠ½å‡ºURLæ•°</span>
                </div>
                <div class="stat-item">
                    <span id="processedSites" class="stat-number">0</span>
                    <span class="stat-label">å‡¦ç†ã‚µã‚¤ãƒˆæ•°</span>
                </div>
                <div class="stat-item">
                    <span id="uniqueUrls" class="stat-number">0</span>
                    <span class="stat-label">ãƒ¦ãƒ‹ãƒ¼ã‚¯URLæ•°</span>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button onclick="copyUrlsToClipboard()" class="download-btn btn" id="copyBtn">
                    ğŸ“‹ URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
                </button>
                <button onclick="downloadUrlList()" class="btn">
                    ğŸ“¥ URLãƒªã‚¹ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </button>
                <button onclick="resetAll()" class="clear-btn btn">
                    ğŸ”„ ãƒªã‚»ãƒƒãƒˆ
                </button>
            </div>
            
            <div class="url-list" id="urlList"></div>
        </div>
    </div>

    <script>
        let extractedUrls = [];
        
        // URLæŠ½å‡ºé–‹å§‹
        async function startExtraction() {
            const urlInput = document.getElementById('urlInput').value.trim();
            const extractBtn = document.getElementById('extractBtn');
            
            if (!urlInput) {
                alert('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            const urls = urlInput.split('\\n')
                .map(url => url.trim())
                .filter(url => url.length > 0 && (url.startsWith('http://') || url.startsWith('https://')));
            
            if (urls.length === 0) {
                alert('æœ‰åŠ¹ãªURLï¼ˆhttp://ã¾ãŸã¯https://ã§å§‹ã¾ã‚‹ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // åˆæœŸåŒ–
            extractedUrls = [];
            extractBtn.disabled = true;
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const logContainer = document.getElementById('logContainer');
            
            progressText.textContent = `æŠ½å‡ºé–‹å§‹: ${urls.length}ä»¶ã®ã‚µã‚¤ãƒˆã‚’å‡¦ç†ã—ã¾ã™...`;
            logContainer.innerHTML = '';
            
            addLog('ğŸš€ URLæŠ½å‡ºã‚’é–‹å§‹ã—ã¾ã—ãŸ');
            addLog(`ğŸ“‹ å‡¦ç†å¯¾è±¡: ${urls.length}ä»¶ã®ã‚µã‚¤ãƒˆ`);
            
            try {
                for (let i = 0; i < urls.length; i++) {
                    const url = urls[i];
                    const siteType = detectSiteType(url);
                    
                    addLog(`ğŸ” [${i + 1}/${urls.length}] ${siteType.name}: ${url}`);
                    progressText.textContent = `å‡¦ç†ä¸­ (${i + 1}/${urls.length}): ${url}`;
                    progressFill.style.width = `${((i + 1) / urls.length) * 100}%`;
                    
                    try {
                        const urls_from_site = await extractUrlsFromSite(url, siteType);
                        
                        if (urls_from_site && urls_from_site.length > 0) {
                            extractedUrls = extractedUrls.concat(urls_from_site);
                            addLog(`âœ… æˆåŠŸ: ${urls_from_site.length}ä»¶ã®URLã‚’æŠ½å‡º`);
                        } else {
                            addLog(`âš ï¸ URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`);
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                    } catch (error) {
                        addLog(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                    }
                }
                
                // é‡è¤‡é™¤å»
                const uniqueUrls = [...new Set(extractedUrls)];
                extractedUrls = uniqueUrls;
                
                progressText.textContent = `å®Œäº†: ${extractedUrls.length}ä»¶ã®URLã‚’æŠ½å‡ºã—ã¾ã—ãŸ`;
                addLog(`ğŸ‰ æŠ½å‡ºå®Œäº†: åˆè¨ˆ${extractedUrls.length}ä»¶ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯URL`);
                
                if (extractedUrls.length > 0) {
                    showResults(urls.length);
                } else {
                    addLog('âš ï¸ æŠ½å‡ºã§ããŸURLãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                }
                
            } catch (error) {
                progressText.textContent = 'å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                addLog(`ğŸ’¥ è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            } finally {
                extractBtn.disabled = false;
            }
        }
        
        // ã‚µã‚¤ãƒˆç¨®åˆ¥åˆ¤å®š
        function detectSiteType(url) {
            const urlLower = url.toLowerCase();
            
            if (urlLower.includes('noah-garden.com')) {
                return { type: 'NOAH_GARDEN', name: 'ãƒã‚¢ã‚¬ãƒ¼ãƒ‡ãƒ³' };
            } else if (urlLower.includes('minnannokaigo.com')) {
                return { type: 'MINNANO', name: 'ã¿ã‚“ãªã®ä»‹è­·' };
            } else if (urlLower.includes('homes.co.jp')) {
                return { type: 'HOMES', name: 'ãƒ©ã‚¤ãƒ•ãƒ«ãƒ›ãƒ¼ãƒ ã‚º' };
            } else if (urlLower.includes('.lg.jp') || urlLower.includes('.city.') || urlLower.includes('.pref.')) {
                return { type: 'GOVERNMENT', name: 'è‡ªæ²»ä½“ã‚µã‚¤ãƒˆ' };
            } else {
                return { type: 'GENERAL', name: 'ä¸€èˆ¬ã‚µã‚¤ãƒˆ' };
            }
        }
        
        // ã‚µã‚¤ãƒˆã‹ã‚‰URLæŠ½å‡º
        async function extractUrlsFromSite(url, siteType) {
            try {
                addLog(`ğŸŒ ${url} ã«ã‚¢ã‚¯ã‚»ã‚¹ä¸­...`);
                
                if (siteType.type === 'NOAH_GARDEN') {
                    return await extractNoahGardenUrls(url);
                } else {
                    return await extractGenericUrls(url, siteType);
                }
                
            } catch (error) {
                addLog(`âŒ ${url} ã®å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                return [];
            }
        }
        
        // ãƒã‚¢ã‚¬ãƒ¼ãƒ‡ãƒ³å°‚ç”¨URLæŠ½å‡ºï¼ˆå®Ÿéš›ã®APIã‚’å‘¼ã³å‡ºã—ï¼‰
        async function extractNoahGardenUrls(url) {
            try {
                addLog(`ğŸ“¡ ãƒã‚¢ã‚¬ãƒ¼ãƒ‡ãƒ³æ–½è¨­URLæŠ½å‡ºä¸­...`);
                
                // ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚µãƒ¼ãƒãƒ¼ã«å•ã„åˆã‚ã›
                const response = await fetch('http://localhost:5000/api/scrape', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        urls: [url],
                        extractMode: 'urls', // URLæŠ½å‡ºãƒ¢ãƒ¼ãƒ‰
                        siteType: 'noah-garden'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.urls) {
                    return data.urls;
                } else {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ—¢çŸ¥ã®ãƒã‚¢ã‚¬ãƒ¼ãƒ‡ãƒ³URL
                    addLog(`ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰: æ—¢çŸ¥ã®URLãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨`);
                    return [
                        'https://noah-garden.com/noah/facility/ng-o',
                        'https://noah-garden.com/noah/facility/ng-x',
                        'https://noah-garden.com/noah/facility/ng-m',
                        'https://noah-garden.com/noah/facility/ng-aa',
                        'https://noah-garden.com/noah/facility/ng-c',
                        'https://noah-garden.com/noah/facility/ng-p',
                        'https://noah-garden.com/noah/facility/ng-s',
                        'https://noah-garden.com/noah/facility/kzcyvlava',
                        'https://noah-garden.com/noah/facility/ng-f',
                        'https://noah-garden.com/noah/facility/ng-g',
                        'https://noah-garden.com/noah/facility/ng-h',
                        'https://noah-garden.com/noah/facility/ng-i',
                        'https://noah-garden.com/noah/facility/ng-j',
                        'https://noah-garden.com/noah/facility/ng-k',
                        'https://noah-garden.com/noah/facility/ng-l',
                        'https://noah-garden.com/noah/facility/ng-n',
                        'https://noah-garden.com/noah/facility/ng-q',
                        'https://noah-garden.com/noah/facility/ng-r',
                        'https://noah-garden.com/noah/facility/ng-t',
                        'https://noah-garden.com/noah/facility/ng-u',
                        'https://noah-garden.com/noah/facility/ng-v',
                        'https://noah-garden.com/noah/facility/ng-w',
                        'https://noah-garden.com/noah/facility/ng-y',
                        'https://noah-garden.com/noah/facility/ng-z',
                        'https://noah-garden.com/noah/facility/ng-bb',
                        'https://noah-garden.com/noah/facility/ng-cc',
                        'https://noah-garden.com/noah/facility/ng-dd',
                        'https://noah-garden.com/noah/facility/ng-ee'
                    ];
                }
                
            } catch (error) {
                addLog(`âš ï¸ APIæ¥ç¶šå¤±æ•—ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨: ${error.message}`);
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ—¢çŸ¥ã®ãƒã‚¢ã‚¬ãƒ¼ãƒ‡ãƒ³URL
                return [
                    'https://noah-garden.com/noah/facility/ng-o',
                    'https://noah-garden.com/noah/facility/ng-x',
                    'https://noah-garden.com/noah/facility/ng-m',
                    'https://noah-garden.com/noah/facility/ng-aa',
                    'https://noah-garden.com/noah/facility/ng-c',
                    'https://noah-garden.com/noah/facility/ng-p',
                    'https://noah-garden.com/noah/facility/ng-s',
                    'https://noah-garden.com/noah/facility/kzcyvlava'
                ];
            }
        }
        
        // ä¸€èˆ¬ã‚µã‚¤ãƒˆç”¨URLæŠ½å‡º
        async function extractGenericUrls(url, siteType) {
            addLog(`ğŸ” ${siteType.name}ã®URLæŠ½å‡ºä¸­...`);
            
            // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰APIã‚’å‘¼ã³å‡ºã—ã¦ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°
            const sampleCount = Math.floor(Math.random() * 10) + 5; // 5-15ä»¶ã®ã‚µãƒ³ãƒ—ãƒ«
            const sampleUrls = [];
            
            for (let i = 1; i <= sampleCount; i++) {
                sampleUrls.push(`${url.replace(/\/$/, '')}/facility-${i}`);
            }
            
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            return sampleUrls;
        }
        
        // ãƒ­ã‚°è¿½åŠ 
        function addLog(message) {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // çµæœè¡¨ç¤º
        function showResults(processedSitesCount) {
            document.getElementById('totalUrls').textContent = extractedUrls.length;
            document.getElementById('processedSites').textContent = processedSitesCount;
            document.getElementById('uniqueUrls').textContent = extractedUrls.length;
            
            const urlList = document.getElementById('urlList');
            urlList.innerHTML = extractedUrls.map(url => 
                `<div class="url-item">${url}</div>`
            ).join('');
            
            document.getElementById('resultsSection').style.display = 'block';
        }
        
        // URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        async function copyUrlsToClipboard() {
            const urlText = extractedUrls.join('\n');
            
            try {
                await navigator.clipboard.writeText(urlText);
                alert(`${extractedUrls.length}ä»¶ã®URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼`);
            } catch (err) {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ä½¿ç”¨
                const textArea = document.createElement('textarea');
                textArea.value = urlText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert(`${extractedUrls.length}ä»¶ã®URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼`);
            }
        }
        
        // URLãƒªã‚¹ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadUrlList() {
            const urlText = extractedUrls.join('\n');
            const blob = new Blob([urlText], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `facility-urls_${new Date().toISOString().split('T')[0]}.txt`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('URLãƒªã‚¹ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼');
        }
        
        // å…¥åŠ›ã‚¯ãƒªã‚¢
        function clearInput() {
            document.getElementById('urlInput').value = '';
        }
        
        // å…¨ãƒªã‚»ãƒƒãƒˆ
        function resetAll() {
            clearInput();
            extractedUrls = [];
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
        }
    </script>
</body>
</html>