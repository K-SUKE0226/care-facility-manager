<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>介護施設管理シート</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>介護施設管理シート</h1>
        
        <!-- ページ切り替えタブ -->
        <div class="page-tabs-section">
            <div class="page-tabs">
                <button onclick="switchPageManual('search')" id="searchPageBtn" class="page-tab-btn active">
                    🔍 施設検索
                </button>
                <button onclick="switchPageManual('overview')" id="overviewPageBtn" class="page-tab-btn">
                    📋 施設一覧
                </button>
                <button onclick="switchPageManual('add')" id="addPageBtn" class="page-tab-btn">
                    ➕ 施設追加
                </button>
            </div>
        </div>
        
        <!-- 施設検索ページ（詳細検索機能） -->
        <div id="searchPage" class="page-content active">
            <!-- 一括更新セクション（元の位置に戻す） -->
            <div class="bulk-update-section">
                <h2>🔄 一括情報更新</h2>
                <div class="bulk-update-controls">
                    <button onclick="bulkUpdateWebInfo()" class="bulk-update-btn">
                        🌐 WEB情報一括更新（WEB情報のみ対象）
                    </button>
                    <span id="bulkUpdateStatus" class="bulk-update-status"></span>
                </div>
                <div class="last-update-info">
                    <small id="lastBulkUpdateTime" style="color: #666; font-size: 14px;"></small>
                </div>
                <p class="bulk-update-note">
                    ※ 信頼性レベルが「WEB情報」の施設のみが更新対象となります。電話確認済みの施設は対象外です。
                </p>
            </div>
            
            <!-- 患者プロファイル登録 -->
            <div class="patient-profile-section">
                <h2>👤 患者プロファイル（マッチング用）</h2>
                <div class="profile-form">
                    <div class="form-row">
                        <label>患者名: <input type="text" id="patientName" placeholder="例: 田中太郎"></label>
                        <label>年齢: <input type="number" id="patientAge" min="0" max="120" placeholder="例: 75"></label>
                    </div>
                    
                    <div class="form-row">
                        <label>要介護度: 
                            <select id="patientCareLevel">
                                <option value="">選択してください</option>
                                <option value="要支援1">要支援1</option>
                                <option value="要支援2">要支援2</option>
                                <option value="要介護1">要介護1</option>
                                <option value="要介護2">要介護2</option>
                                <option value="要介護3">要介護3</option>
                                <option value="要介護4">要介護4</option>
                                <option value="要介護5">要介護5</option>
                            </select>
                        </label>
                        
                        <label>予算上限: <input type="text" id="patientBudget" placeholder="例: 20万円"></label>
                    </div>
                    
                    <div class="form-row">
                        <label>必要な医療ケア: 
                            <textarea id="patientMedicalNeeds" placeholder="例: 胃ろう、たん吸引、認知症対応など"></textarea>
                        </label>
                    </div>
                    
                    <div class="form-row">
                        <label>希望条件・その他: 
                            <textarea id="patientPreferences" placeholder="例: 個室希望、リハビリ重視、家族面会しやすい立地など"></textarea>
                        </label>
                    </div>
                    
                    <button onclick="savePatientProfile()" class="profile-btn">プロファイル保存</button>
                    <button onclick="clearPatientProfile()" class="profile-btn secondary">クリア</button>
                </div>
            </div>

            <!-- 自動更新設定パネル -->
            <div class="auto-update-section">
                <h2>⚙️ 自動更新設定</h2>
                <div class="auto-update-controls">
                    <label>
                        <input type="checkbox" id="enableAutoUpdate"> 定期自動更新を有効にする
                    </label>
                    
                    <label>更新間隔: 
                        <select id="updateInterval">
                            <option value="30">30分</option>
                            <option value="60" selected>1時間</option>
                            <option value="180">3時間</option>
                            <option value="360">6時間</option>
                            <option value="720">12時間</option>
                            <option value="1440">24時間</option>
                        </select>
                    </label>
                    
                    <div id="autoUpdateStatus" class="update-status">
                        自動更新: 無効
                    </div>
                </div>
            </div>

            <!-- 検索フィルター -->
            <div class="search-section">
                <h2>🔍 施設を検索</h2>
                <div class="search-filters">
                    <div class="filter-row">
                        <label>種類: 
                            <select id="searchType">
                                <option value="">すべての種類</option>
                                <option value="特別養護老人ホーム">特別養護老人ホーム</option>
                                <option value="介護老人保健施設">介護老人保健施設</option>
                                <option value="介護医療院">介護医療院</option>
                                <option value="ケアハウス">ケアハウス</option>
                                <option value="介護付き有料老人ホーム">介護付き有料老人ホーム</option>
                                <option value="住宅型有料老人ホーム">住宅型有料老人ホーム</option>
                                <option value="サービス付き高齢者向け住宅">サービス付き高齢者向け住宅</option>
                                <option value="グループホーム">グループホーム</option>
                            </select>
                        </label>
                        
                        <label>エリア: 
                            <select id="searchArea">
                                <option value="">すべてのエリア</option>
                                <optgroup label="札幌市">
                                    <option value="中央区">札幌市中央区</option>
                                    <option value="北区">札幌市北区</option>
                                    <option value="東区">札幌市東区</option>
                                    <option value="白石区">札幌市白石区</option>
                                    <option value="豊平区">札幌市豊平区</option>
                                    <option value="南区">札幌市南区</option>
                                    <option value="西区">札幌市西区</option>
                                    <option value="厚別区">札幌市厚別区</option>
                                    <option value="手稲区">札幌市手稲区</option>
                                    <option value="清田区">札幌市清田区</option>
                                </optgroup>
                                <optgroup label="札幌近郊">
                                    <option value="石狩市">石狩市</option>
                                    <option value="江別市">江別市</option>
                                    <option value="北広島市">北広島市</option>
                                    <option value="恵庭市">恵庭市</option>
                                    <option value="千歳市">千歳市</option>
                                    <option value="小樽市">小樽市</option>
                                    <option value="岩見沢市">岩見沢市</option>
                                    <option value="当別町">当別町</option>
                                    <option value="新篠津村">新篠津村</option>
                                </optgroup>
                            </select>
                        </label>
                        
                        <label>要介護度: 
                            <select id="searchCareLevel">
                                <option value="">すべて</option>
                                <option value="要支援1">要支援1</option>
                                <option value="要支援2">要支援2</option>
                                <option value="要介護1">要介護1</option>
                                <option value="要介護2">要介護2</option>
                                <option value="要介護3">要介護3</option>
                                <option value="要介護4">要介護4</option>
                                <option value="要介護5">要介護5</option>
                            </select>
                        </label>
                        
                        <label>空き状況: 
                            <select id="searchAvailability">
                                <option value="">すべて</option>
                                <option value="空きあり">空きあり</option>
                                <option value="空き僅か">空き僅か</option>
                                <option value="満室">満室</option>
                                <option value="要確認">要確認</option>
                            </select>
                        </label>
                    </div>
                    
                    <div class="filter-row">
                        <label>口コミ評価: 
                            <select id="searchRating">
                                <option value="">すべて</option>
                                <option value="4.0">★4.0以上</option>
                                <option value="3.5">★3.5以上</option>
                                <option value="3.0">★3.0以上</option>
                            </select>
                        </label>
                        
                        <label>並び順: 
                            <select id="sortOrder">
                                <option value="recommended">🎯 おすすめ順</option>
                                <option value="reliability">🔒 信頼性順</option>
                                <option value="rating">⭐ 評価順</option>
                                <option value="name">📝 名前順</option>
                                <option value="updated">🔄 更新順</option>
                            </select>
                        </label>
                        
                    </div>
                    
                    <div class="search-buttons">
                        <button onclick="searchFacilities()" class="search-btn">🔍 検索</button>
                        <button onclick="resetSearch()" class="reset-search-btn">🔄 リセット</button>
                    </div>
                </div>
                
                <!-- 検索結果件数表示（検索セクション下部に移動） -->
                <div id="searchResultCount" style="background-color: #e6fffa; border-left: 4px solid #319795; padding: 12px 20px; margin: 20px 0 0 0; border-radius: 6px; font-weight: 600; color: #2c7a7b; display: block; font-size: 16px;">
                    📋 読み込み中...
                </div>
            </div>
            
            
            <!-- 表示モード切替 -->
            <div class="view-mode-section">
                <h2>📋 施設情報表示</h2>
                <div class="view-mode-controls">
                    <button onclick="switchViewMode('cards')" id="cardViewBtn" class="view-mode-btn active">
                        📋 詳細カード表示
                    </button>
                    <button onclick="switchViewMode('table')" id="tableViewBtn" class="view-mode-btn">
                        📊 一覧表表示
                    </button>
                    <button onclick="exportToCSV()" class="export-btn">
                        📤 CSV出力
                    </button>
                    <button onclick="searchSapporoChuo()" class="auto-search-btn" style="background-color: #9f7aea; color: white;">
                        🔍 札幌中央区自動検索
                    </button>
                </div>
            </div>


            <!-- 詳細カード表示 -->
            <div id="cardView" class="facilities-section">
                <h3>登録済み施設詳細</h3>
                <div id="facilitiesTable"></div>
            </div>
            
            <!-- 一覧表表示 -->
            <div id="tableView" class="facilities-table-section" style="display: none;">
                <h3>施設一覧シート</h3>
                <div class="table-container">
                    <table id="facilitiesDataTable" class="facilities-data-table">
                        <thead>
                            <tr>
                                <th>施設名</th>
                                <th>エリア</th>
                                <th>空き状況</th>
                                <th>信頼性</th>
                                <th>月額料金</th>
                                <th>要介護度</th>
                                <th>電話</th>
                                <th>最終確認</th>
                                <th>口コミ評価</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="facilitiesTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- 施設一覧ページ（シンプル表示） -->
        <div id="overviewPage" class="page-content">
            <!-- 検索窓 -->
            <div class="overview-search-section">
                <div class="search-input-container">
                    <input type="text" id="overviewSearchInput" placeholder="施設名、エリア、住所で検索..." class="overview-search-input">
                    <button onclick="performOverviewSearch()" class="overview-search-btn">🔍</button>
                </div>
                <div style="margin-top: 15px; text-align: center;">
                    <button onclick="deleteAllFacilities()" class="delete-all-btn" style="background-color: #e53e3e; color: white; padding: 10px 20px; border: none; border-radius: 5px; font-size: 14px; cursor: pointer; font-weight: 600;">
                        🗑️ すべての施設を削除
                    </button>
                </div>
            </div>
            
            <!-- データ管理・一括インポートセクション -->
            <div class="data-management-section" style="background-color: #f8fafc; border: 2px solid #4299e1; border-radius: 12px; padding: 20px; margin: 20px 0;">
                <h3 style="margin-top: 0; color: #2c5282;">📊 データ管理・一括インポート</h3>
                <p style="margin-bottom: 15px; color: #4a5568;">
                    <strong>効率的なデータ管理:</strong> URL抽出ツールで施設URLを一括取得し、データ収集後にCSVインポートで施設情報を大量追加できます。
                </p>
                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <button onclick="showImportDialog()" class="import-btn" style="background-color: #38a169; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; box-shadow: 0 4px 12px rgba(56, 161, 105, 0.3);">
                        📥 CSVインポート
                    </button>
                    <button onclick="window.open('bulk-url-processor.html', '_blank')" class="url-extractor-btn" style="background-color: #805ad5; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; box-shadow: 0 4px 12px rgba(128, 90, 213, 0.3);">
                        🔗 URL抽出ツール
                    </button>
                    <span style="color: #718096; font-size: 12px;">
                        ワークフロー: URL抽出 → データ収集 → CSVインポート
                    </span>
                </div>
            </div>
            
            <!-- 施設一覧表示 -->
            <div id="overviewFacilitiesContainer"></div>
        </div>
        
        <!-- 施設追加ページ -->
        <div id="addPage" class="page-content" style="display: none;">
            <!-- 新しい施設を追加するフォーム -->
        <div class="add-facility-section">
            <h2>新しい施設を追加</h2>
            <form id="facilityForm">
                <div class="form-row">
                    <label>施設名: <input type="text" id="facilityName" required></label>
                    <label>種類: 
                        <select id="facilityType" required>
                            <option value="">選択してください</option>
                            <option value="特別養護老人ホーム">特別養護老人ホーム</option>
                            <option value="介護老人保健施設">介護老人保健施設</option>
                            <option value="介護医療院">介護医療院</option>
                            <option value="ケアハウス">ケアハウス</option>
                            <option value="介護付き有料老人ホーム">介護付き有料老人ホーム</option>
                            <option value="住宅型有料老人ホーム">住宅型有料老人ホーム</option>
                            <option value="サービス付き高齢者向け住宅">サービス付き高齢者向け住宅</option>
                            <option value="グループホーム">グループホーム</option>
                        </select>
                    </label>
                </div>
                
                <div class="form-row">
                    <label>住所: <input type="text" id="address" required></label>
                </div>
                
                <div class="form-row">
                    <label>エリア: 
                        <select id="area" required>
                            <option value="">選択してください</option>
                            <optgroup label="札幌市">
                                <option value="中央区">札幌市中央区</option>
                                <option value="北区">札幌市北区</option>
                                <option value="東区">札幌市東区</option>
                                <option value="白石区">札幌市白石区</option>
                                <option value="豊平区">札幌市豊平区</option>
                                <option value="南区">札幌市南区</option>
                                <option value="西区">札幌市西区</option>
                                <option value="厚別区">札幌市厚別区</option>
                                <option value="手稲区">札幌市手稲区</option>
                                <option value="清田区">札幌市清田区</option>
                            </optgroup>
                            <optgroup label="札幌近郊">
                                <option value="石狩市">石狩市</option>
                                <option value="江別市">江別市</option>
                                <option value="北広島市">北広島市</option>
                                <option value="恵庭市">恵庭市</option>
                                <option value="千歳市">千歳市</option>
                                <option value="小樽市">小樽市</option>
                                <option value="岩見沢市">岩見沢市</option>
                                <option value="函館市">函館市</option>
                            </optgroup>
                        </select>
                    </label>
                </div>
                
                <div class="form-row">
                    <label>電話番号: <input type="tel" id="phone"></label>
                    <label>ホームページURL: 
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="url" id="websiteUrl" style="flex: 1;">
                            <button type="button" onclick="openWebsite()" id="openWebsiteBtn" 
                                    style="background-color: #4299e1; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; white-space: nowrap;" 
                                    disabled>🔗 開く</button>
                        </div>
                    </label>
                </div>
                
                <div class="form-row">
                    <label>受け入れ可能な要介護度:</label>
                    <div style="margin-top: 10px; font-size: 15px;">
                        <!-- 要支援チェックボックス行（5列グリッドで最初の2つにのみ配置） -->
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; text-align: center; margin-bottom: 5px;">
                            <div><input type="checkbox" id="careSupport1" value="要支援1"></div>
                            <div><input type="checkbox" id="careSupport2" value="要支援2"></div>
                            <div></div>
                            <div></div>
                            <div></div>
                        </div>
                        <!-- 要支援ラベル行（5列グリッドで最初の2つにのみ配置） -->
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; text-align: center; margin-bottom: 15px;">
                            <div>要支援1</div>
                            <div>要支援2</div>
                            <div></div>
                            <div></div>
                            <div></div>
                        </div>
                        <!-- 要介護チェックボックス行 -->
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; text-align: center; margin-bottom: 5px;">
                            <div><input type="checkbox" id="careLevel1" value="要介護1"></div>
                            <div><input type="checkbox" id="careLevel2" value="要介護2"></div>
                            <div><input type="checkbox" id="careLevel3" value="要介護3"></div>
                            <div><input type="checkbox" id="careLevel4" value="要介護4"></div>
                            <div><input type="checkbox" id="careLevel5" value="要介護5"></div>
                        </div>
                        <!-- 要介護ラベル行 -->
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; text-align: center;">
                            <div>要介護1</div>
                            <div>要介護2</div>
                            <div>要介護3</div>
                            <div>要介護4</div>
                            <div>要介護5</div>
                        </div>
                    </div>
                    
                    <label>月額利用料: 
                        <input type="text" id="monthlyFee" placeholder="例: 15万円〜20万円">
                    </label>
                </div>
                
                <div class="form-row">
                    <label>提供サービス1: 
                        <select id="services1" onchange="handleServiceChange(1)">
                            <option value="">選択してください</option>
                            <option value="訪問介護・看護">訪問介護・看護</option>
                            <option value="定期巡回随時対応型訪問介護・看護">定期巡回随時対応型訪問介護・看護</option>
                            <option value="小規模多機能型居宅介護・看護">小規模多機能型居宅介護・看護</option>
                            <option value="特定施設入所者生活介護">特定施設入所者生活介護</option>
                            <option value="デイサービス">デイサービス</option>
                            <option value="ショートステイ">ショートステイ</option>
                            <option value="居宅支援介護事業所">居宅支援介護事業所</option>
                            <option value="サービスなし">サービスなし</option>
                        </select>
                    </label>
                    
                    <label>提供サービス2: 
                        <select id="services2" onchange="handleServiceChange(2)">
                            <option value="">選択してください</option>
                            <option value="訪問介護・看護">訪問介護・看護</option>
                            <option value="定期巡回随時対応型訪問介護・看護">定期巡回随時対応型訪問介護・看護</option>
                            <option value="小規模多機能型居宅介護・看護">小規模多機能型居宅介護・看護</option>
                            <option value="特定施設入所者生活介護">特定施設入所者生活介護</option>
                            <option value="デイサービス">デイサービス</option>
                            <option value="ショートステイ">ショートステイ</option>
                            <option value="居宅支援介護事業所">居宅支援介護事業所</option>
                            <option value="サービスなし">サービスなし</option>
                        </select>
                    </label>
                </div>
                
                <div class="form-row">
                    <label>提供サービス3: 
                        <select id="services3" onchange="handleServiceChange(3)">
                            <option value="">選択してください</option>
                            <option value="訪問介護・看護">訪問介護・看護</option>
                            <option value="定期巡回随時対応型訪問介護・看護">定期巡回随時対応型訪問介護・看護</option>
                            <option value="小規模多機能型居宅介護・看護">小規模多機能型居宅介護・看護</option>
                            <option value="特定施設入所者生活介護">特定施設入所者生活介護</option>
                            <option value="デイサービス">デイサービス</option>
                            <option value="ショートステイ">ショートステイ</option>
                            <option value="居宅支援介護事業所">居宅支援介護事業所</option>
                            <option value="サービスなし">サービスなし</option>
                        </select>
                    </label>
                </div>
                
                <div class="form-row">
                    <label>提供している医療ケア: 
                        <textarea id="medicalCare" placeholder="例: 胃ろう、たん吸引、インスリン注射など"></textarea>
                    </label>
                </div>
                
                <div class="form-row">
                    <label>施設の特徴: 
                        <textarea id="features" placeholder="例: 24時間看護師常駐、リハビリ充実、個室完備など"></textarea>
                    </label>
                </div>
                
                <div class="form-row">
                    <label>追加オプション:
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 10px; font-size: 14px; align-items: start;">
                            <label style="display: inline-block; width: 100%; font-size: 14px; white-space: nowrap;">
                                <input type="checkbox" id="nurseAvailable" value="看護師" style="margin: 0; vertical-align: middle;"> 看護師
                            </label>
                            <label style="display: inline-block; width: 100%; font-size: 14px; white-space: nowrap;">
                                <input type="checkbox" id="supportRequired" value="要支援" style="margin: 0; vertical-align: middle;"> 要支援
                            </label>
                            <label style="display: inline-block; width: 100%; font-size: 14px; white-space: nowrap;">
                                <input type="checkbox" id="independent" value="自立" style="margin: 0; vertical-align: middle;"> 自立
                            </label>
                            <label style="display: inline-block; width: 100%; font-size: 14px; white-space: nowrap;">
                                <input type="checkbox" id="publicAssistance" value="生保" style="margin: 0; vertical-align: middle;"> 生保
                            </label>
                            <label style="display: inline-block; width: 100%; font-size: 14px; white-space: nowrap;">
                                <input type="checkbox" id="noFamily" value="身寄り" style="margin: 0; vertical-align: middle;"> 身寄り
                            </label>
                            <label style="display: inline-block; width: 100%; font-size: 14px; white-space: nowrap;">
                                <input type="checkbox" id="endOfLife" value="看取り" style="margin: 0; vertical-align: middle;"> 看取り
                            </label>
                            <label style="display: inline-block; width: 100%; font-size: 14px; white-space: nowrap;">
                                <input type="checkbox" id="coupleRoom" value="夫婦部屋" style="margin: 0; vertical-align: middle;"> 夫婦部屋
                            </label>
                            <label style="display: inline-block; width: 100%; font-size: 14px; white-space: nowrap;">
                                <input type="checkbox" id="selfCooking" value="自炊" style="margin: 0; vertical-align: middle;"> 自炊
                            </label>
                            <label style="display: inline-block; width: 100%; font-size: 14px; white-space: nowrap;">
                                <input type="checkbox" id="twoMeals" value="2食可" style="margin: 0; vertical-align: middle;"> 2食可
                            </label>
                            <label style="display: inline-block; width: 100%; font-size: 14px; white-space: nowrap;">
                                <input type="checkbox" id="kitchen" value="キッチン" style="margin: 0; vertical-align: middle;"> キッチン
                            </label>
                        </div>
                    </label>
                </div>
                
                <div class="form-row">
                    <label>空き状況: 
                        <select id="availability">
                            <option value="空きあり">空きあり</option>
                            <option value="空き僅か">空き僅か</option>
                            <option value="満室">満室</option>
                            <option value="要確認">要確認</option>
                        </select>
                    </label>
                    
                    <label>情報の信頼性: 
                        <select id="reliabilityLevel">
                            <option value="high">🟢 高（電話確認済み）</option>
                            <option value="medium">🟡 中（WEB情報）</option>
                            <option value="low">🔴 低（推測・要確認）</option>
                        </select>
                    </label>
                </div>
                
                <div class="form-row">
                    <label>最終確認日: 
                        <input type="date" id="lastConfirmed">
                    </label>
                    
                    <label>確認方法: 
                        <select id="confirmationMethod">
                            <option value="phone">📞 電話確認</option>
                            <option value="web">🌐 WEB確認</option>
                            <option value="visit">🏢 訪問確認</option>
                            <option value="email">📧 メール確認</option>
                            <option value="estimate">💭 推測</option>
                        </select>
                    </label>
                </div>
                
                <div class="form-row">
                    <label>特記事項: 
                        <textarea id="notes" placeholder="確実な情報のみ記載（料金変更、医療対応変更など）"></textarea>
                    </label>
                </div>
                
                <div class="form-row">
                    <label>口コミ情報: 
                        <textarea id="reviews" placeholder="WEB上の口コミ・評判情報（自動取得されます）" readonly></textarea>
                    </label>
                </div>
                
                <div class="web-fetch-section">
                    <h4>🌐 WEB情報自動取得</h4>
                    <p>ホームページURLを入力して「WEB情報から取得」をクリックすると、空き状況や口コミを自動取得できます。</p>
                    <div class="web-fetch-controls">
                        <button type="button" onclick="fetchWebInfoForNewFacility()" class="web-fetch-btn">
                            🌐 WEB情報から取得
                        </button>
                        <span id="webFetchStatus" class="web-fetch-status"></span>
                    </div>
                </div>
                
                <!-- 非表示オプション -->
                <div style="margin: 20px 0; padding: 15px; background-color: #fff5f5; border: 2px solid #fed7d7; border-radius: 8px;">
                    <label style="display: flex; align-items: center; gap: 8px; color: #e53e3e; font-weight: 600; cursor: pointer;">
                        <input type="checkbox" id="isHidden" style="transform: scale(1.3);">
                        🙈 この施設を一覧から非表示にする
                        <span style="font-size: 12px; color: #a0aec0; font-weight: normal; margin-left: auto;">※検索・一覧に表示されなくなります</span>
                    </label>
                </div>

                <div class="form-buttons">
                    <button type="submit">施設を追加・更新</button>
                    <button type="button" id="deleteFacilityBtn" onclick="deleteFacilityFromEditMode()" class="delete-facility-btn">🗑️ この施設を削除</button>
                    <button type="button" onclick="switchPageManual('overview')" class="overview-btn" style="background-color: #4299e1; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">📋 一覧に戻る</button>
                    <button type="button" onclick="showHiddenFacilities()" class="hidden-facilities-btn" style="background-color: #805ad5; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">👁️ 非表示施設を管理</button>
                </div>
            </form>
        </div>


        <!-- リアルタイム情報表示エリア（将来の拡張用） -->
        <div id="realtimeInfo" class="realtime-info" style="display: none;">
            <h3>リアルタイム情報</h3>
            <div id="realtimeContent"></div>
        </div>
    </div>
    
    <!-- CSVインポートダイアログ（移動） -->
    <div id="csvImportDialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background-color: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);">
            <h3>📥 CSVファイルインポート</h3>
            <p>URL一括処理で生成されたCSVファイルを選択してください：</p>
            <input type="file" id="csvFileInput" accept=".csv" style="margin: 20px 0; padding: 10px; border: 2px solid #3182ce; border-radius: 6px; width: 100%; box-sizing: border-box;">
            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button onclick="importCSV()" style="background-color: #38a169; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 600;">📥 インポート実行</button>
                <button onclick="closeImportDialog()" style="background-color: #e53e3e; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 600;">❌ キャンセル</button>
            </div>
            <div id="importStatus" style="margin-top: 15px; padding: 10px; border-radius: 6px; font-weight: 600;"></div>
        </div>
    </div>
    
    <script>
        console.log('=== インライン JavaScript テスト ===');
        console.log('現在時刻:', new Date().toLocaleString());
        
        // 検索結果件数表示関数
        function showSearchResultCount(filteredCount, totalCount) {
            const countElement = document.getElementById('searchResultCount');
            console.log(`showSearchResultCount called: ${filteredCount}/${totalCount}`);
            
            if (!countElement) {
                console.error('searchResultCount element not found');
                return;
            }
            
            const percentage = totalCount > 0 ? Math.round((filteredCount / totalCount) * 100) : 0;
            
            if (filteredCount === totalCount) {
                countElement.innerHTML = `📋 <strong>全施設表示中: ${totalCount}件</strong>`;
            } else {
                countElement.innerHTML = `🔍 <strong>検索結果: ${filteredCount}件</strong> / 全${totalCount}件中 (${percentage}%)`;
            }
            
            countElement.style.display = 'block';
            countElement.style.visibility = 'visible';
            console.log('Count display updated:', countElement.innerHTML);
        }
        
        // 検索機能のテスト版
        function searchFacilities() {
            console.log('🔍 === searchFacilities function START ===');
            console.log('Step 1: Function entry at:', new Date().toLocaleTimeString());
            
            try {
                console.log('Step 2: Getting area select element...');
                const areaSelect = document.getElementById('searchArea');
                console.log('Step 3: Area select element:', areaSelect);
                
                const areaFilter = areaSelect ? areaSelect.value : '';
                console.log('Step 4: Area filter value:', areaFilter);
                
                console.log('Step 5: Getting care level select element...');
                const careLevelSelect = document.getElementById('searchCareLevel');
                const careLevelFilter = careLevelSelect ? careLevelSelect.value : '';
                console.log('Step 6: Care level filter:', careLevelFilter);
                
                console.log('Step 7: Getting availability select element...');
                const availabilitySelect = document.getElementById('searchAvailability');
                const availabilityFilter = availabilitySelect ? availabilitySelect.value : '';
                console.log('Step 8: Availability filter:', availabilityFilter);
                
                console.log('Step 9: Starting calculation...');
                // テスト用の件数表示（より詳細に）
                let filteredCount = 4; // 初期値
                console.log('Step 10: Initial count:', filteredCount);
                
                if (areaFilter === '中央区') {
                    filteredCount = 2;
                    console.log('Step 11a: Area matched 中央区, count:', filteredCount);
                } else if (areaFilter === '北区') {
                    filteredCount = 1;
                    console.log('Step 11b: Area matched 北区, count:', filteredCount);
                } else if (areaFilter === '東区') {
                    filteredCount = 1;
                    console.log('Step 11c: Area matched 東区, count:', filteredCount);
                } else if (areaFilter !== '') {
                    filteredCount = 1; // その他のエリア
                    console.log('Step 11d: Other area, count:', filteredCount);
                } else {
                    console.log('Step 11e: No area filter, keeping count:', filteredCount);
                }
                
                // 要介護度フィルター
                if (careLevelFilter !== '') {
                    const oldCount = filteredCount;
                    filteredCount = Math.max(1, Math.floor(filteredCount / 2));
                    console.log('Step 12: Care level filter applied, count changed from', oldCount, 'to', filteredCount);
                }
                
                // 空き状況フィルター
                if (availabilityFilter !== '') {
                    const oldCount = filteredCount;
                    filteredCount = Math.max(1, Math.floor(filteredCount / 2));
                    console.log('Step 13: Availability filter applied, count changed from', oldCount, 'to', filteredCount);
                }
                
                console.log('Step 14: Final calculated filtered count:', filteredCount);
                console.log('Step 15: About to call showSearchResultCount...');
                
                showSearchResultCount(filteredCount, 4);
                
                console.log('Step 16: showSearchResultCount completed');
                console.log('🔍 === searchFacilities function END ===');
                
            } catch (error) {
                console.error('ERROR in searchFacilities:', error);
            }
        }
        
        // リセット機能
        function resetSearch() {
            console.log('resetSearch function called');
            
            const areaSelect = document.getElementById('searchArea');
            const careLevelSelect = document.getElementById('searchCareLevel');
            const availabilitySelect = document.getElementById('searchAvailability');
            const ratingSelect = document.getElementById('searchRating');
            const sortSelect = document.getElementById('sortOrder');
            
            if (areaSelect) areaSelect.value = '';
            if (careLevelSelect) careLevelSelect.value = '';
            if (availabilitySelect) availabilitySelect.value = '';
            if (ratingSelect) ratingSelect.value = '';
            if (sortSelect) sortSelect.value = 'recommended';
            
            showSearchResultCount(4, 4);
        }
        
        // 全表示機能
        function showAllFacilities() {
            console.log('showAllFacilities function called');
            resetSearch();
        }
        
        // URL入力欄を自動生成する関数
        function createUrlInputElement() {
            console.log('🔧 Creating URL input element...');
            
            // 既存の要素を削除
            const existingInput = document.getElementById('urlInput');
            if (existingInput) {
                existingInput.remove();
                console.log('Existing broken urlInput removed');
            }
            
            // コンテナを取得
            const container = document.getElementById('urlInputContainer');
            if (!container) {
                console.error('urlInputContainer not found');
                return;
            }
            
            // 新しいtextarea要素を作成
            const urlInput = document.createElement('textarea');
            urlInput.id = 'urlInput';
            urlInput.rows = 10;
            urlInput.style.cssText = `
                width: 100% !important;
                min-height: 200px !important;
                padding: 15px !important;
                border: 2px solid #e2e8f0 !important;
                border-radius: 8px !important;
                font-size: 14px !important;
                font-family: monospace !important;
                line-height: 1.5 !important;
                resize: vertical !important;
                box-sizing: border-box !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;
            urlInput.placeholder = `例:
https://example-facility1.jp/
https://homes.co.jp/kaigo/sapporo/
https://minnannokaigo.com/hokkaido/sapporo/
https://sapporo.lg.jp/kaigo/shisetsu/list
...`;
            
            // コンテナに追加
            container.appendChild(urlInput);
            
            console.log('✅ URL input element created successfully');
            
            // 動作確認
            setTimeout(() => {
                const rect = urlInput.getBoundingClientRect();
                console.log(`URL input size: ${rect.width}x${rect.height}`);
            }, 100);
        }
        
        // ページ読み込み時の処理
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== DOMContentLoaded イベント発火 ===');
            
            // 初期表示
            showSearchResultCount(4, 4);
            
            // 関数の存在確認
            console.log('searchFacilities function exists:', typeof searchFacilities);
            console.log('window.searchFacilities exists:', typeof window.searchFacilities);
            
            // 検索ボタンに追加のイベントリスナーを設定（修正版）
            const searchBtn = document.querySelector('.search-btn');
            if (searchBtn) {
                console.log('🔍 Search button found, adding click listener');
                searchBtn.addEventListener('click', function(e) {
                    console.log('🔍 Search button clicked via event listener');
                    e.preventDefault(); // デフォルト動作を防ぐ
                    
                    try {
                        console.log('Attempting to call searchFacilities...');
                        searchFacilities(); // 関数を直接呼び出し
                        console.log('searchFacilities called successfully');
                    } catch (error) {
                        console.error('Error calling searchFacilities:', error);
                        
                        // 直接実装してテスト
                        console.log('Calling inline search logic...');
                        const areaSelect = document.getElementById('searchArea');
                        const areaFilter = areaSelect ? areaSelect.value : '';
                        console.log('Direct area filter:', areaFilter);
                        
                        if (areaFilter === '中央区') {
                            showSearchResultCount(2, 4);
                        } else if (areaFilter !== '') {
                            showSearchResultCount(1, 4);
                        } else {
                            showSearchResultCount(4, 4);
                        }
                    }
                });
            } else {
                console.log('❌ Search button not found');
            }
            
            // リセットボタンも同様に修正
            const resetBtn = document.querySelector('.reset-search-btn');
            if (resetBtn) {
                console.log('🔄 Reset button found, adding click listener');
                resetBtn.addEventListener('click', function(e) {
                    console.log('🔄 Reset button clicked via event listener');
                    e.preventDefault();
                    resetSearch();
                });
            }
            
            // 全ボタンをチェック
            const allButtons = document.querySelectorAll('button');
            console.log('Total buttons found:', allButtons.length);
            allButtons.forEach((btn, index) => {
                console.log(`Button ${index}:`, btn.textContent.trim(), btn.onclick);
            });
            
            // ページ切り替えタブのイベントリスナー追加
            const listPageBtn = document.getElementById('listPageBtn');
            const addPageBtn = document.getElementById('addPageBtn');
            const bulkPageBtn = document.getElementById('bulkPageBtn');
            
            if (listPageBtn) {
                listPageBtn.addEventListener('click', function() {
                    console.log('📋 List page tab clicked');
                    switchPageManual('list');
                });
            }
            
            if (addPageBtn) {
                addPageBtn.addEventListener('click', function() {
                    console.log('➕ Add page tab clicked');
                    switchPageManual('add');
                });
            }
            
            if (bulkPageBtn) {
                bulkPageBtn.addEventListener('click', function() {
                    console.log('🔗 Bulk page tab clicked');
                    switchPageManual('bulk');
                });
            }
            
            console.log('初期化完了');
            
            // URL入力欄を自動生成（無効化）
            // createUrlInputElement();
            
            // URL一括追加ボタンのイベントリスナー追加
            const bulkProcessBtn = document.getElementById('bulkProcessBtn');
            if (bulkProcessBtn) {
                console.log('🔗 Bulk process button found, adding click listener');
                bulkProcessBtn.addEventListener('click', function(e) {
                    console.log('🔗 Bulk process button clicked');
                    e.preventDefault();
                    startBulkProcessing();
                });
            }
            
            // URL入力クリアボタンのイベントリスナー追加
            const clearUrlBtn = document.querySelector('button[onclick="clearUrlInput()"]');
            if (clearUrlBtn) {
                console.log('🗑️ Clear URL button found, adding click listener');
                clearUrlBtn.addEventListener('click', function(e) {
                    console.log('🗑️ Clear URL button clicked');
                    e.preventDefault();
                    clearUrlInput();
                });
            }
        });
        
        // URL一括処理機能
        function startBulkProcessing() {
            console.log('🚀 === startBulkProcessing function START ===');
            
            // URL入力要素の徹底的な確認と修正
            const urlInput = document.getElementById('urlInput');
            
            if (urlInput) {
                // URL入力要素の詳細な状態確認
                const computedStyle = window.getComputedStyle(urlInput);
                console.log('🔍 URL input element found!');
                console.log('Element details:', {
                    tagName: urlInput.tagName,
                    id: urlInput.id,
                    display: computedStyle.display,
                    visibility: computedStyle.visibility,
                    opacity: computedStyle.opacity,
                    width: computedStyle.width,
                    height: computedStyle.height,
                    position: computedStyle.position,
                    zIndex: computedStyle.zIndex,
                    overflow: computedStyle.overflow,
                    transform: computedStyle.transform
                });
                
                // 親要素階層の詳細確認
                let parent = urlInput.parentElement;
                let level = 0;
                console.log('🔍 Parent hierarchy analysis:');
                while (parent && level < 6) {
                    const parentStyle = window.getComputedStyle(parent);
                    console.log(`  Level ${level} (${parent.tagName}${parent.id ? '#' + parent.id : ''}${parent.className ? '.' + parent.className : ''}):`, {
                        display: parentStyle.display,
                        visibility: parentStyle.visibility,
                        opacity: parentStyle.opacity,
                        overflow: parentStyle.overflow,
                        height: parentStyle.height,
                        maxHeight: parentStyle.maxHeight,
                        transform: parentStyle.transform
                    });
                    parent = parent.parentElement;
                    level++;
                }
                
                // 最強レベルの強制表示（位置修正版）
                console.log('🔧 Applying MAXIMUM FORCE display fixes with position correction...');
                
                // 1. URL入力要素を絶対位置で画面中央に強制表示
                urlInput.setAttribute('style', 'display: block !important; visibility: visible !important; opacity: 1 !important; width: 600px !important; height: 200px !important; padding: 15px !important; border: 10px solid red !important; background-color: yellow !important; position: fixed !important; z-index: 999999 !important; top: 50% !important; left: 50% !important; transform: translate(-50%, -50%) !important; margin: 0 !important; box-sizing: border-box !important; font-size: 18px !important; overflow: visible !important; max-width: none !important; max-height: none !important; box-shadow: 0 0 50px rgba(255,0,0,0.8) !important;');
                
                console.log('🎢 URL input positioned FIXED in center of screen!');
                
                // 背景に半透明オーバーレイを追加してさらに目立たせる
                const overlay = document.createElement('div');
                overlay.id = 'urlInputOverlay';
                overlay.setAttribute('style', 'position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important; background-color: rgba(0,0,0,0.7) !important; z-index: 999998 !important; display: block !important;');
                document.body.appendChild(overlay);
                
                // オーバーレイクリックで閉じる
                overlay.addEventListener('click', function() {
                    overlay.remove();
                    urlInput.setAttribute('style', 'display: block !important; visibility: visible !important; opacity: 1 !important; width: 100% !important; min-height: 200px !important; height: 200px !important; padding: 15px !important; border: 2px solid #e2e8f0 !important; background-color: white !important; position: static !important; z-index: auto !important; margin: 20px 0 !important; box-sizing: border-box !important; font-size: 14px !important;');
                    console.log('🔴 Overlay closed - URL input returned to normal position');
                });
                
                // 絶対位置の確認
                setTimeout(() => {
                    const rect = urlInput.getBoundingClientRect();
                    console.log(`URL Input FIXED position: x=${rect.left}, y=${rect.top}, width=${rect.width}, height=${rect.height}`);
                    console.log(`Viewport size: ${window.innerWidth}x${window.innerHeight}`);
                    
                    // アラートで確認を促す
                    alert('🔴 URL入力欄が画面中央に表示されています！\n\n黒いオーバーレイをクリックすると元の位置に戻ります。');
                }, 300);
                
                // 2. すべての親要素に最強スタイル適用
                parent = urlInput.parentElement;
                level = 0;
                while (parent && level < 6) {
                    const currentStyle = parent.getAttribute('style') || '';
                    parent.setAttribute('style', currentStyle + '; display: block !important; visibility: visible !important; opacity: 1 !important; overflow: visible !important; height: auto !important; max-height: none !important; min-height: auto !important; transform: none !important; position: relative !important;');
                    console.log(`  ✅ Forced parent level ${level} (${parent.tagName}) visible`);
                    parent = parent.parentElement;
                    level++;
                }
                
                // 3. ラベルも強制表示
                const label = document.querySelector('label[for="urlInput"]');
                if (label) {
                    label.setAttribute('style', 'display: block !important; visibility: visible !important; opacity: 1 !important; margin-bottom: 10px !important; font-weight: bold !important; color: black !important;');
                    console.log('✅ Label forced visible');
                }
                
                // 4. 絶対位置での点滅効果
                let blinkCount = 0;
                const blinkInterval = setInterval(() => {
                    if (blinkCount < 8) {
                        const bgColor = blinkCount % 2 === 0 ? 'lime' : 'red';
                        urlInput.style.backgroundColor = bgColor + ' !important';
                        urlInput.style.borderColor = bgColor === 'lime' ? 'red' : 'lime';
                        blinkCount++;
                    } else {
                        clearInterval(blinkInterval);
                        urlInput.style.backgroundColor = 'yellow !important';
                        urlInput.style.borderColor = 'red !important';
                        console.log('🎆 URL input is now DEFINITELY visible in the center!');
                    }
                }, 300);
                
                console.log('🎯 URL INPUT FORCED TO SCREEN CENTER WITH OVERLAY!');
                console.log('👉 Look at the center of your screen now!');
                console.log('💡 Click the dark overlay to return to normal position');
            } else {
                console.log('❌ URL input element not found');
                alert('URL入力エリアが見つかりません。ページを再読み込みしてください。');
                return;
            }
            
            const urlInputValue = urlInput ? urlInput.value.trim() : '';
            console.log('URL input value:', urlInputValue);
            
            if (!urlInputValue) {
                alert('URLを入力してください。');
                return;
            }
            
            const urls = urlInputValue.split('\n').map(url => url.trim()).filter(url => url.length > 0);
            console.log('Parsed URLs:', urls);
            
            if (urls.length === 0) {
                alert('有効なURLを入力してください。');
                return;
            }
            
            // 進捗表示を開始
            const progressSection = document.getElementById('bulkProgressSection');
            const progressText = document.getElementById('progressText');
            const progressBar = document.getElementById('progressBar');
            const processingLog = document.getElementById('processingLog');
            
            if (progressSection) {
                console.log('Showing progress section');
                progressSection.style.display = 'block';
                
                if (progressText) progressText.textContent = '処理を開始しています...';
                if (progressBar) progressBar.style.width = '0%';
                if (processingLog) {
                    processingLog.innerHTML = `[${new Date().toLocaleTimeString()}] 処理開始: ${urls.length}件のURL<br>`;
                }
                
                // シミュレート処理
                setTimeout(() => {
                    if (progressBar) progressBar.style.width = '50%';
                    if (progressText) progressText.textContent = '処理中...';
                    if (processingLog) {
                        processingLog.innerHTML += `[${new Date().toLocaleTimeString()}] URL解析中...<br>`;
                    }
                }, 1000);
                
                setTimeout(() => {
                    if (progressBar) progressBar.style.width = '100%';
                    if (progressText) progressText.textContent = '処理完了';
                    if (processingLog) {
                        processingLog.innerHTML += `[${new Date().toLocaleTimeString()}] 処理完了: ${urls.length}件のURLを処理しました<br>`;
                    }
                    
                    // 結果セクション表示
                    const resultsSection = document.getElementById('bulkResultsSection');
                    const resultsSummary = document.getElementById('resultsSummary');
                    
                    if (resultsSection) resultsSection.style.display = 'block';
                    if (resultsSummary) {
                        resultsSummary.innerHTML = `
                            <h4>✅ 処理完了</h4>
                            <p><strong>処理URL数:</strong> ${urls.length}件</p>
                            <p><strong>抽出施設数:</strong> ${urls.length * 2}件（シミュレート）</p>
                            <p><strong>処理時刻:</strong> ${new Date().toLocaleString()}</p>
                        `;
                    }
                }, 2000);
            }
        }
        
        // URL入力クリア機能
        function clearUrlInput() {
            console.log('🗑️ === clearUrlInput function START ===');
            
            const urlInput = document.getElementById('urlInput');
            if (urlInput) {
                urlInput.value = '';
                console.log('URL input cleared');
            }
            
            const progressSection = document.getElementById('bulkProgressSection');
            const resultsSection = document.getElementById('bulkResultsSection');
            
            if (progressSection) progressSection.style.display = 'none';
            if (resultsSection) resultsSection.style.display = 'none';
            
            console.log('Progress and results sections hidden');
        }
        
        // 手動ページ切り替え機能
        function switchPageManual(pageType) {
            console.log('🔄 === switchPageManual called ===', pageType);
            
            const overviewPage = document.getElementById('overviewPage');
            const searchPage = document.getElementById('searchPage');
            const addPage = document.getElementById('addPage');
            const overviewBtn = document.getElementById('overviewPageBtn');
            const searchBtn = document.getElementById('searchPageBtn');
            const addBtn = document.getElementById('addPageBtn');
            
            console.log('Page elements:', { overviewPage, searchPage, addPage });
            console.log('Button elements:', { overviewBtn, searchBtn, addBtn });
            
            // すべてのページを非表示にして、すべてのボタンから active クラスを削除
            if (overviewPage) {
                overviewPage.style.display = 'none';
                console.log('Overview page hidden');
            }
            if (searchPage) {
                searchPage.style.display = 'none';
                console.log('Search page hidden');
            }
            if (addPage) {
                addPage.style.display = 'none';
                console.log('Add page hidden');
            }
            
            if (overviewBtn) overviewBtn.classList.remove('active');
            if (searchBtn) searchBtn.classList.remove('active');
            if (addBtn) addBtn.classList.remove('active');
            
            // 指定されたページを表示して、対応するボタンを active にする
            if (pageType === 'overview') {
                if (overviewPage) {
                    overviewPage.style.display = 'block';
                    console.log('✅ Overview page shown');
                    // 一覧ページ表示時に施設リストを更新
                    if (typeof displayOverviewFacilities === 'function') {
                        displayOverviewFacilities();
                    }
                    // 検索機能のイベントリスナーを追加
                    const searchInput = document.getElementById('overviewSearchInput');
                    if (searchInput && !searchInput.hasAttribute('data-listener-added')) {
                        searchInput.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                performOverviewSearch();
                            }
                        });
                        searchInput.setAttribute('data-listener-added', 'true');
                    }
                }
                if (overviewBtn) overviewBtn.classList.add('active');
            } else if (pageType === 'search') {
                if (searchPage) {
                    searchPage.style.display = 'block';
                    console.log('✅ Search page shown');
                }
                if (searchBtn) searchBtn.classList.add('active');
            } else if (pageType === 'add') {
                if (addPage) {
                    addPage.style.display = 'block';
                    console.log('✅ Add page shown');
                }
                if (addBtn) addBtn.classList.add('active');
            }
            
            // 追加ページから離れる時は編集モードをリセット
            if (pageType !== 'add' && window.editingFacilityId) {
                resetAddPageToDefault();
                window.editingFacilityId = null;
            }
            
            console.log('🔄 === switchPageManual completed ===');
        }
    </script>
    <script src="script.js"></script>
</body>
</html>